<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0a0c10" />
  <title>DataPulse â€” Analytics Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS  â€”  all fluid / clamp-based
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg:         #0a0c10;
      --surface:    #111318;
      --card:       #161b24;
      --border:     #1f2535;
      --accent:     #00e5ff;
      --accent2:    #ff4fd8;
      --accent3:    #a3ff70;
      --text:       #e8edf5;
      --muted:      #6b7a99;
      --danger:     #ff5c5c;
      --fh:         'Syne', sans-serif;
      --fm:         'DM Mono', monospace;
      --sidebar-w:  clamp(200px, 20vw, 260px);
      --topbar-h:   clamp(52px, 8vh, 68px);
      --gap:        clamp(10px, 2vw, 24px);
      --pad:        clamp(12px, 3vw, 32px);
      --r:          clamp(8px, 1.5vw, 14px);
    }

    /* â”€â”€ THEME: Midnight (default dark) â€” already in :root â”€â”€ */

    /* â”€â”€ THEME: Arctic Light â”€â”€ */
    [data-theme="light"] {
      --bg:      #f0f4fa;
      --surface: #ffffff;
      --card:    #ffffff;
      --border:  #dde3ef;
      --accent:  #0066ff;
      --accent2: #cc00cc;
      --accent3: #22aa44;
      --text:    #ffffff;
      --muted:   #6b7a99;
      --danger:  #e03333;
    }
    [data-theme="light"] body::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='none'/%3E%3Cline x1='0' y1='60' x2='60' y2='0' stroke='%2300000008' stroke-width='.5'/%3E%3C/svg%3E");
    }

    /* â”€â”€ THEME: Forest (deep green) â”€â”€ */
    [data-theme="forest"] {
      --bg:      #080e0a;
      --surface: #0d1610;
      --card:    #111e14;
      --border:  #1a2e1e;
      --accent:  #39ff8a;
      --accent2: #00d4aa;
      --accent3: #ffe066;
      --text:    #d4eed9;
      --muted:   #5e8068;
      --danger:  #ff5c5c;
    }

    /* â”€â”€ THEME: Ember (warm orange/red) â”€â”€ */
    [data-theme="ember"] {
      --bg:      #0e0905;
      --surface: #160e07;
      --card:    #1e130a;
      --border:  #2e1d0e;
      --accent:  #ff8c00;
      --accent2: #ff3a6e;
      --accent3: #ffd700;
      --text:    #f5e6d0;
      --muted:   #957060;
      --danger:  #ff4444;
    }

    /* â”€â”€ THEME: Violet Dusk â”€â”€ */
    [data-theme="violet"] {
      --bg:      #09080f;
      --surface: #100e1a;
      --card:    #161326;
      --border:  #221d38;
      --accent:  #b47cff;
      --accent2: #ff6ec7;
      --accent3: #7affd4;
      --text:    #ede8ff;
      --muted:   #7060a0;
      --danger:  #ff5c5c;
    }

    /* â”€â”€ Theme switcher panel â”€â”€ */
    .theme-panel {
      position: absolute;
      top: calc(var(--topbar-h) + 6px);
      right: var(--pad);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      z-index: 300;
      display: none;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
      min-width: 180px;
      animation: fadeUp .22s ease both;
    }
    .theme-panel.open { display: flex; }
    .theme-panel-title {
      font-family: var(--fm);
      font-size: .68rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 2px;
    }
    .theme-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      font-size: .82rem;
      font-weight: 600;
      color: var(--text);
      background: none;
      transition: background .15s, border-color .15s;
      width: 100%;
      text-align: left;
    }
    .theme-option:hover   { background: var(--surface); }
    .theme-option.active  { border-color: var(--accent); background: rgba(var(--accent-rgb,.5), .08); }
    .theme-dot {
      width: 14px; height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid rgba(255,255,255,.15);
    }

    /* theme toggle button */
    .btn-theme {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 5px;
      padding: clamp(7px,1.2vh,10px) clamp(10px,1.5vw,14px);
      border-radius: var(--r);
      font-family: var(--fh);
      font-size: clamp(.7rem,1.1vw,.82rem);
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      white-space: nowrap;
      min-height: 38px;
      position: relative;
    }
    .btn-theme:hover { border-color: var(--accent); color: var(--accent); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLOBAL RESET
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0; padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    html {
      font-size: 16px;
      height: 100%;
      scroll-behavior: smooth;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--fh);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='none'/%3E%3Cline x1='0' y1='60' x2='60' y2='0' stroke='%23ffffff05' stroke-width='.5'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }
    img, canvas, svg { max-width: 100%; display: block; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APP SHELL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .app {
      display: flex;
      min-height: 100dvh;
      position: relative;
      z-index: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100dvh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0; top: 0; bottom: 0;
      z-index: 200;
      overflow-y: auto;
      overflow-x: hidden;
      transition: transform .3s cubic-bezier(.4,0,.2,1), box-shadow .3s;
      padding-left: env(safe-area-inset-left, 0px);
    }
    .sidebar-logo {
      padding: clamp(16px,3vh,28px) clamp(14px,2vw,24px) clamp(12px,2vh,18px);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-logo .brand {
      font-size: clamp(1.05rem, 2vw, 1.4rem);
      font-weight: 800;
      letter-spacing: -.5px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .sidebar-logo small {
      display: block;
      font-family: var(--fm);
      font-size: clamp(.55rem, 1vw, .65rem);
      color: var(--muted);
      margin-top: 2px;
      -webkit-text-fill-color: var(--muted);
    }
    .nav {
      flex: 1;
      padding: clamp(10px, 1.5vh, 16px) clamp(8px, 1vw, 12px);
      display: flex; flex-direction: column; gap: 3px;
    }
    .nav-item {
      display: flex; align-items: center;
      gap: clamp(8px, 1vw, 12px);
      padding: clamp(10px, 1.4vh, 13px) clamp(10px, 1.2vw, 14px);
      border-radius: calc(var(--r) - 2px);
      font-size: clamp(.78rem, 1.2vw, .9rem);
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border: none; background: none;
      width: 100%; text-align: left;
      min-height: 44px;
      transition: background .15s, color .15s;
      white-space: nowrap;
    }
    .nav-item:hover   { background: var(--card); color: var(--text); }
    .nav-item.active  { background: rgba(0,229,255,.09); color: var(--accent); }
    .nav-item:disabled { opacity: .38; cursor: not-allowed; }
    .nav-icon { font-size: .95em; width: 20px; text-align: center; flex-shrink: 0; }
    .sidebar-footer {
      padding: clamp(10px,1.5vh,16px) clamp(12px,1.5vw,16px);
      border-top: 1px solid var(--border);
      font-family: var(--fm);
      font-size: clamp(.58rem, .9vw, .67rem);
      color: var(--muted);
      line-height: 1.7; flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex; flex-direction: column;
      min-height: 100dvh;
      min-width: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOPBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 var(--pad);
      height: var(--topbar-h);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
      gap: 8px;
      padding-right: max(var(--pad), env(safe-area-inset-right, 0px));
    }
    .topbar-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .topbar h1 {
      font-size: clamp(.82rem, 1.8vw, 1.1rem);
      font-weight: 700;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .topbar-actions { display: flex; align-items: center; gap: clamp(6px, 1vw, 12px); flex-shrink: 0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 5px;
      padding: clamp(7px,1.2vh,10px) clamp(10px,1.5vw,18px);
      border-radius: var(--r);
      font-family: var(--fh);
      font-size: clamp(.7rem, 1.1vw, .82rem);
      font-weight: 600; cursor: pointer;
      transition: all .2s; border: none;
      white-space: nowrap; min-height: 38px;
    }
    .btn-ghost   { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--card); color: var(--text); }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { opacity: .85; transform: translateY(-1px); }

    .hamburger {
      display: none;
      background: none; border: none; color: var(--text);
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      cursor: pointer; padding: 6px;
      min-width: 40px; min-height: 40px;
      align-items: center; justify-content: center;
      border-radius: 8px;
    }
    .hamburger:hover { background: var(--card); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTENT AREA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .content {
      padding: var(--pad);
      flex: 1; min-width: 0;
      padding-bottom: max(var(--pad), env(safe-area-inset-bottom, 0px));
    }

    /* Mobile sidebar backdrop */
    .overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      z-index: 150;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }
    .overlay.open { display: block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #section-upload    { display: block; }
    #section-dashboard { display: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UPLOAD PAGE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .upload-hero {
      max-width: min(720px, 100%);
      margin: 0 auto;
      text-align: center;
      padding: clamp(20px,5vh,48px) 0 clamp(14px,3vh,28px);
    }
    .upload-hero h2 {
      font-size: clamp(1.4rem, 5vw, 2.6rem);
      font-weight: 800;
      letter-spacing: clamp(-.5px,-.05em,-1px);
      line-height: 1.1; margin-bottom: 12px;
    }
    .upload-hero h2 span {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .upload-hero p {
      font-family: var(--fm);
      font-size: clamp(.73rem, 1.5vw, .9rem);
      color: var(--muted); line-height: 1.7;
    }

    .drop-zone {
      max-width: min(720px, 100%);
      margin: clamp(14px,3vh,32px) auto;
      border: 2px dashed var(--border);
      border-radius: clamp(12px,2vw,20px);
      padding: clamp(28px,6vh,64px) clamp(16px,4vw,48px);
      text-align: center; cursor: pointer;
      transition: border-color .25s, background .25s, box-shadow .25s;
      background: var(--card);
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(0,229,255,.04);
      box-shadow: 0 0 40px rgba(0,229,255,.08);
    }
    .drop-icon { font-size: clamp(1.8rem,5vw,3rem); margin-bottom: 12px; }
    .drop-zone h3 { font-size: clamp(.95rem,2vw,1.2rem); font-weight: 700; margin-bottom: 7px; }
    .drop-zone p  { font-family: var(--fm); font-size: clamp(.7rem,1.2vw,.82rem); color: var(--muted); margin-bottom: 20px; }
    #file-input   { display: none; }

    .formats-grid {
      max-width: min(720px, 100%);
      margin: 0 auto clamp(20px,4vh,40px);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(170px,100%), 1fr));
      gap: var(--gap);
    }
    .format-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r);
      padding: clamp(12px,2.5vh,22px);
      transition: border-color .2s;
    }
    .format-card:hover { border-color: var(--accent); }
    .format-icon { font-size: clamp(1.3rem,3vw,1.9rem); margin-bottom: 7px; }
    .format-card h4 { font-size: clamp(.8rem,1.3vw,.95rem); font-weight: 700; margin-bottom: 4px; }
    .format-card p  { font-family: var(--fm); font-size: clamp(.63rem,1vw,.74rem); color: var(--muted); line-height: 1.6; }
    .format-badge {
      display: inline-block; margin-top: 8px; padding: 2px 8px; border-radius: 4px;
      font-family: var(--fm); font-size: clamp(.58rem,.8vw,.67rem);
      background: rgba(0,229,255,.12); color: var(--accent);
    }

    .upload-progress {
      max-width: min(720px,100%); margin: 0 auto clamp(10px,2vh,20px); display: none;
    }
    .progress-label {
      font-family: var(--fm); font-size: clamp(.65rem,1vw,.75rem); color: var(--muted);
      margin-bottom: 7px; display: flex; justify-content: space-between;
    }
    .progress-bar-wrap { background: var(--border); border-radius: 100px; height: 5px; overflow: hidden; }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 100px; width: 0%; transition: width .4s ease;
    }

    .sample-section { max-width: min(720px,100%); margin: 0 auto; text-align: center; }
    .sample-section > p { font-family: var(--fm); font-size: clamp(.66rem,.9vw,.75rem); color: var(--muted); margin-bottom: 12px; }
    .sample-btns { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .btn-sample {
      padding: clamp(5px,.8vh,8px) clamp(10px,1.5vw,16px);
      border-radius: 7px; font-family: var(--fm);
      font-size: clamp(.68rem,1vw,.78rem);
      background: var(--card); color: var(--text);
      border: 1px solid var(--border); cursor: pointer;
      transition: border-color .2s, color .2s; min-height: 36px;
    }
    .btn-sample:hover { border-color: var(--accent); color: var(--accent); }

    .info-box {
      max-width: min(720px,100%); margin: clamp(20px,4vh,40px) auto 0;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r); padding: clamp(14px,3vw,26px);
    }
    .info-box h3 { font-size: clamp(.8rem,1.2vw,.92rem); font-weight: 700; margin-bottom: 10px; }
    .info-box p  { font-family: var(--fm); font-size: clamp(.65rem,1vw,.75rem); color: var(--muted); line-height: 1.9; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD â€” EXPORT BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .export-bar {
      display: flex; align-items: center;
      gap: clamp(5px,1vw,12px); flex-wrap: wrap;
      margin-bottom: var(--gap);
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r);
      padding: clamp(9px,1.5vh,16px) clamp(12px,2vw,20px);
    }
    .export-bar > span { font-family: var(--fm); font-size: clamp(.65rem,1vw,.75rem); color: var(--muted); }
    #file-info { font-family: var(--fm); font-size: clamp(.6rem,.9vw,.7rem); color: var(--muted); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KPI CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(140px,100%), 1fr));
      gap: var(--gap); margin-bottom: var(--gap);
    }
    .kpi-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r);
      padding: clamp(12px,2.5vh,22px);
      position: relative; overflow: hidden;
      transition: transform .2s, border-color .2s;
    }
    .kpi-card:hover { transform: translateY(-2px); border-color: var(--accent); }
    .kpi-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity: 0; transition: opacity .2s;
    }
    .kpi-card:hover::before { opacity: 1; }
    .kpi-label {
      font-family: var(--fm);
      font-size: clamp(.6rem,.9vw,.7rem); color: var(--muted);
      text-transform: uppercase; letter-spacing: .08em; margin-bottom: 5px;
    }
    .kpi-value {
      font-size: clamp(1.4rem, 3.5vw, 2.2rem); font-weight: 800; letter-spacing: -1px;
      background: linear-gradient(135deg, var(--text), var(--muted));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      line-height: 1.1;
    }
    .kpi-sub { font-family: var(--fm); font-size: clamp(.58rem,.85vw,.68rem); color: var(--accent3); margin-top: 4px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHART GRIDS  â€”  fully fluid with auto-fit
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .charts-primary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(300px,100%), 1fr));
      gap: var(--gap); margin-bottom: var(--gap);
    }
    .charts-secondary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(260px,100%), 1fr));
      gap: var(--gap); margin-bottom: var(--gap);
    }
    .chart-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r);
      padding: clamp(14px,2.5vw,26px); min-width: 0;
    }
    .chart-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: clamp(10px,2vh,20px); gap: 8px; flex-wrap: wrap;
    }
    .chart-title    { font-size: clamp(.8rem,1.3vw,.95rem); font-weight: 700; }
    .chart-subtitle { font-family: var(--fm); font-size: clamp(.6rem,.9vw,.7rem); color: var(--muted); margin-top: 2px; }
    .chart-actions  { display: flex; gap: 4px; flex-wrap: wrap; flex-shrink: 0; }
    .btn-chart {
      padding: clamp(3px,.6vh,6px) clamp(6px,1vw,10px);
      border-radius: 6px; font-family: var(--fm);
      font-size: clamp(.6rem,.85vw,.7rem);
      background: var(--surface); color: var(--muted);
      border: 1px solid var(--border); cursor: pointer;
      transition: all .2s; min-height: 28px;
    }
    .btn-chart:hover, .btn-chart.active {
      background: rgba(0,229,255,.1); color: var(--accent); border-color: var(--accent);
    }
    /* Fluid chart height â€” taller on large screens, shorter on phones */
    .chart-wrap {
      position: relative; width: 100%;
      height: clamp(160px, 26vh, 300px);
    }
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATA TABLE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .table-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r); overflow: hidden; margin-bottom: var(--gap);
    }
    .table-header {
      padding: clamp(10px,2vh,20px) clamp(12px,2vw,24px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 8px;
    }
    .table-title { font-size: clamp(.8rem,1.3vw,.95rem); font-weight: 700; }
    .search-input {
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 7px 14px; font-family: var(--fm);
      font-size: clamp(.68rem,1vw,.78rem); color: var(--text); outline: none;
      width: clamp(130px,28vw,240px); transition: border-color .2s; min-height: 36px;
    }
    .search-input::placeholder { color: var(--muted); }
    .search-input:focus { border-color: var(--accent); }

    .col-selector {
      display: flex; align-items: center; gap: 7px; flex-wrap: wrap;
      padding: clamp(7px,1.3vh,14px) clamp(12px,2vw,24px);
      border-bottom: 1px solid var(--border);
    }
    .col-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px clamp(6px,1vw,10px); border-radius: 5px;
      font-family: var(--fm); font-size: clamp(.58rem,.82vw,.7rem);
      background: var(--surface); border: 1px solid var(--border);
      color: var(--muted); cursor: pointer; transition: all .2s;
      user-select: none; min-height: 28px;
    }
    .col-badge.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,.08); }

    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table       { width: 100%; border-collapse: collapse; }
    thead tr    { border-bottom: 1px solid var(--border); }
    th {
      padding: clamp(7px,1.2vh,13px) clamp(9px,1.5vw,18px);
      text-align: left; font-family: var(--fm);
      font-size: clamp(.6rem,.85vw,.72rem); color: var(--muted);
      text-transform: uppercase; letter-spacing: .07em;
      white-space: nowrap; cursor: pointer; user-select: none;
    }
    th:hover { color: var(--accent); }
    td {
      padding: clamp(7px,1.1vh,12px) clamp(9px,1.5vw,18px);
      font-family: var(--fm); font-size: clamp(.68rem,1vw,.78rem);
      color: var(--text); white-space: nowrap;
      border-bottom: 1px solid rgba(31,37,53,.5);
    }
    tbody tr:hover  { background: rgba(255,255,255,.025); }
    tbody tr:last-child td { border-bottom: none; }

    .pagination {
      padding: clamp(9px,1.4vh,15px) clamp(12px,2vw,24px);
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      font-family: var(--fm); font-size: clamp(.63rem,.95vw,.74rem);
      color: var(--muted); flex-wrap: wrap; gap: 8px;
    }
    .page-btns { display: flex; gap: 4px; flex-wrap: wrap; }
    .page-btn {
      width: clamp(28px,4vw,32px); height: clamp(28px,4vw,32px);
      border-radius: 6px; background: var(--surface); border: 1px solid var(--border);
      color: var(--muted); font-family: var(--fm);
      font-size: clamp(.65rem,.9vw,.74rem); cursor: pointer;
      transition: all .2s;
      display: flex; align-items: center; justify-content: center;
    }
    .page-btn:hover, .page-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      right:  max(14px, env(safe-area-inset-right,  14px));
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: clamp(9px,1.4vh,14px) clamp(12px,2vw,22px);
      font-family: var(--fm); font-size: clamp(.7rem,1vw,.8rem);
      color: var(--text); box-shadow: 0 8px 32px rgba(0,0,0,.5);
      z-index: 9999; transform: translateY(80px); opacity: 0;
      transition: all .3s ease;
      display: flex; align-items: center; gap: 8px;
      max-width: min(340px, calc(100vw - 28px));
    }
    .toast.show    { transform: translateY(0); opacity: 1; }
    .toast.success { border-left: 3px solid var(--accent3); }
    .toast.error   { border-left: 3px solid var(--danger); }
    .toast.info    { border-left: 3px solid var(--accent); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .anim   { animation: fadeUp .38s ease both; }
    .anim-1 { animation-delay: .05s; }
    .anim-2 { animation-delay: .10s; }
    .anim-3 { animation-delay: .15s; }
    .anim-4 { animation-delay: .20s; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE BREAKPOINTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* Tablet portrait â€” hide sidebar, show hamburger */
    @media (max-width: 860px) {
      .sidebar {
        width: clamp(220px, 72vw, 280px);
        transform: translateX(-110%);
        box-shadow: none;
      }
      .sidebar.open {
        transform: translateX(0);
        box-shadow: 4px 0 30px rgba(0,0,0,.65);
      }
      .main      { margin-left: 0; }
      .hamburger { display: inline-flex; }
    }

    /* Mobile â€” compact spacing */
    @media (max-width: 600px) {
      :root { --pad: 12px; --gap: 10px; }
      /* hide reset in topbar to save space â€” still in nav */
      #btn-reset { display: none !important; }
      .export-bar .btn { padding: 6px 10px; font-size: .68rem; }
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
    }

    /* Very small phones (320â€“380px) */
    @media (max-width: 390px) {
      :root { --pad: 10px; --gap: 8px; }
      .kpi-value  { font-size: 1.3rem; }
      .chart-wrap { height: 150px; }
      .upload-hero h2 { font-size: 1.3rem; }
      .drop-zone  { padding: 22px 14px; }
      .formats-grid { grid-template-columns: 1fr; }
    }

    /* Landscape phones â€” reduce heights */
    @media (max-height: 500px) and (orientation: landscape) {
      .topbar       { height: 46px; }
      .chart-wrap   { height: 130px; }
      .upload-hero  { padding: 8px 0 10px; }
      .drop-zone    { padding: 18px 14px; }
    }

    /* Large / ultrawide */
    @media (min-width: 1600px) {
      :root { --sidebar-w: 280px; --pad: 40px; --gap: 28px; }
      .kpi-row { grid-template-columns: repeat(5, 1fr); }
    }

    /* Print */
    @media print {
      .sidebar, .topbar, .hamburger, .overlay,
      .export-bar, .topbar-actions, .chart-actions,
      .col-selector, .pagination, .search-input { display: none !important; }
      .main    { margin-left: 0; }
      .content { padding: 0; }
      .chart-card, .kpi-card, .table-card { border: 1px solid #ccc; break-inside: avoid; }
      body     { background: #fff; color: #000; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation: none !important; transition-duration: .01ms !important; }
    }
  </style>
</head>
<body>

<div class="app">

  <!-- â•â• SIDEBAR â•â• -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-logo">
      <span class="brand">DataPulse</span>
      <small>Business Intelligence v2.0</small>
    </div>
    <nav class="nav">
      <button class="nav-item active" onclick="showSection('upload')">
        <span class="nav-icon">ğŸ“</span> Import Data
      </button>
      <button class="nav-item" id="nav-dashboard" onclick="showSection('dashboard')" disabled>
        <span class="nav-icon">ğŸ“Š</span> Dashboard
      </button>
      <button class="nav-item" onclick="goToTable()">
        <span class="nav-icon">ğŸ—ƒï¸</span> Data Table
      </button>
      <button class="nav-item" onclick="exportAll()">
        <span class="nav-icon">â¬‡ï¸</span> Export
      </button>
    </nav>
    <div class="sidebar-footer">
      Supported: CSV Â· JSON Â· TSV<br>
      Recommended max: 50 MB<br>
      Â© 2026 DataPulse | UnknownMeh
    </div>
  </aside>

  <!-- Backdrop -->
  <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

  <div class="main" style="position:relative">

    <!-- â•â• TOPBAR â•â• -->
    <header class="topbar" role="banner">
      <div class="topbar-left">
        <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
        <h1 id="topbar-title">Import Data</h1>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-ghost" id="btn-reset" onclick="resetDashboard()" style="display:none">â†º Reset</button>
        <button class="btn-theme" id="btn-theme" onclick="toggleThemePanel()" aria-label="Change theme" aria-haspopup="true" aria-expanded="false">
          <span id="theme-icon">ğŸŒ™</span> Theme
        </button>
        <button class="btn btn-primary" onclick="triggerUpload()">+ Upload</button>
      </div>
    </header>

    <!-- Theme switcher panel -->
    <div class="theme-panel" id="theme-panel" role="listbox" aria-label="Choose theme">
      <div class="theme-panel-title">Choose Theme</div>
      <button class="theme-option active" data-theme="dark"   onclick="applyTheme('dark',this)"   role="option"><span class="theme-dot" style="background:#00e5ff"></span> Midnight</button>
      <button class="theme-option"        data-theme="light"  onclick="applyTheme('light',this)"  role="option"><span class="theme-dot" style="background:#0066ff"></span> Arctic Light</button>
      <button class="theme-option"        data-theme="forest" onclick="applyTheme('forest',this)" role="option"><span class="theme-dot" style="background:#39ff8a"></span> Forest</button>
      <button class="theme-option"        data-theme="ember"  onclick="applyTheme('ember',this)"  role="option"><span class="theme-dot" style="background:#ff8c00"></span> Ember</button>
      <button class="theme-option"        data-theme="violet" onclick="applyTheme('violet',this)" role="option"><span class="theme-dot" style="background:#b47cff"></span> Violet Dusk</button>
    </div>

    <main class="content" role="main">

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           UPLOAD SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <section id="section-upload">
        <div class="upload-hero anim">
          <h2>Transform your data<br>into <span>Visual Intelligence</span></h2>
          <p>Upload any structured data file. DataPulse auto-detects columns,<br class="br-hide" />generates smart charts and surfaces key insights instantly.</p>
        </div>

        <div class="drop-zone anim anim-1" id="drop-zone"
             role="button" tabindex="0"
             aria-label="Drop file here or click to browse"
             ondragover="handleDragOver(event)"
             ondragleave="handleDragLeave()"
             ondrop="handleDrop(event)"
             onclick="triggerUpload()"
             onkeydown="if(event.key==='Enter'||event.key===' ')triggerUpload()">
          <div class="drop-icon">ğŸ“‚</div>
          <h3>Drop your file here</h3>
          <p>or tap / click to browse from your device</p>
          <button class="btn btn-primary" onclick="event.stopPropagation();triggerUpload()">Browse Files</button>
          <input type="file" id="file-input" accept=".csv,.json,.tsv,.txt" onchange="handleFileInput(event)" />
        </div>

        <div class="upload-progress" id="upload-progress" role="status" aria-live="polite">
          <div class="progress-label">
            <span id="progress-text">Parsing fileâ€¦</span>
            <span id="progress-pct">0%</span>
          </div>
          <div class="progress-bar-wrap">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
        </div>

        <p style="max-width:min(720px,100%);margin:0 auto 13px;font-size:clamp(.65rem,.9vw,.74rem);color:var(--muted);font-family:var(--fm);text-transform:uppercase;letter-spacing:.08em;" class="anim anim-2">
          Supported File Formats
        </p>
        <div class="formats-grid anim anim-2">
          <div class="format-card">
            <div class="format-icon">ğŸ“„</div>
            <h4>CSV</h4>
            <p>Comma-Separated Values. Most common export from Excel, Google Sheets, databases and BI tools.</p>
            <span class="format-badge">.csv</span>
          </div>
          <div class="format-card">
            <div class="format-icon">ğŸ—‚ï¸</div>
            <h4>JSON</h4>
            <p>Array-of-objects format from REST APIs, web scrapers and app data exports.</p>
            <span class="format-badge">.json</span>
          </div>
          <div class="format-card">
            <div class="format-icon">ğŸ“‘</div>
            <h4>TSV</h4>
            <p>Tab-Separated Values. Common from bioinformatics tools and Excel tab-delimited exports.</p>
            <span class="format-badge">.tsv</span>
          </div>
        </div>

        <div class="sample-section anim anim-3">
          <p>â€” or try a built-in sample dataset â€”</p>
          <div class="sample-btns">
            <button class="btn-sample" onclick="loadSample('sales')">ğŸ“ˆ Monthly Sales</button>
            <button class="btn-sample" onclick="loadSample('employees')">ğŸ‘¥ HR Employees</button>
            <button class="btn-sample" onclick="loadSample('ecommerce')">ğŸ›’ E-Commerce Orders</button>
          </div>
        </div>

        <div class="info-box anim anim-4">
          <h3>ğŸ“‹ Data Format Guide</h3>
          <p>
            <strong style="color:var(--text)">CSV / TSV:</strong> First row must be column headers. Each row is one record.<br>
            Example: <code style="color:var(--accent)">Date,Product,Revenue,Units,Region</code><br><br>
            <strong style="color:var(--text)">JSON:</strong> Provide a top-level array of objects with consistent keys.<br>
            Example: <code style="color:var(--accent)">[{"date":"2024-01-01","revenue":12500,"region":"North"}]</code><br><br>
            <strong style="color:var(--text)">Best practices:</strong> Include a date/time column for trend charts. At least one numeric column is needed for KPIs. Column names with spaces are supported. Keep files under ~100 k rows for optimal browser performance.
          </p>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DASHBOARD SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <section id="section-dashboard">

        <div class="export-bar anim">
          <span>Export:</span>
          <button class="btn btn-ghost" onclick="exportCSV()">â¬‡ CSV</button>
          <button class="btn btn-ghost" onclick="exportJSON()">â¬‡ JSON</button>
          <button class="btn btn-ghost" onclick="exportChartPNG()">ğŸ–¼ PNG</button>
          <button class="btn btn-ghost" onclick="printDashboard()">ğŸ–¨ Print</button>
          <div style="flex:1;min-width:0"></div>
          <span id="file-info"></span>
        </div>

        <div class="kpi-row" id="kpi-row"></div>

        <!-- Primary charts (Trend + Distribution) -->
        <div class="charts-primary">
          <div class="chart-card anim anim-1">
            <div class="chart-header">
              <div>
                <div class="chart-title">Trend Analysis</div>
                <div class="chart-subtitle" id="trend-subtitle">Numeric values over rows</div>
              </div>
              <div class="chart-actions">
                <button class="btn-chart active" onclick="setChartType('trend','line',this)">Line</button>
                <button class="btn-chart" onclick="setChartType('trend','bar',this)">Bar</button>
                <button class="btn-chart" onclick="setChartType('trend','area',this)">Area</button>
              </div>
            </div>
            <div class="chart-wrap"><canvas id="chart-trend"></canvas></div>
          </div>

          <div class="chart-card anim anim-2">
            <div class="chart-header">
              <div>
                <div class="chart-title">Distribution</div>
                <div class="chart-subtitle" id="dist-subtitle">Category breakdown</div>
              </div>
              <div class="chart-actions">
                <button class="btn-chart active" onclick="setChartType('dist','doughnut',this)">Donut</button>
                <button class="btn-chart" onclick="setChartType('dist','pie',this)">Pie</button>
              </div>
            </div>
            <div class="chart-wrap"><canvas id="chart-dist"></canvas></div>
          </div>
        </div>

        <!-- Secondary charts (Comparison + Scatter) -->
        <div class="charts-secondary">
          <div class="chart-card anim anim-3">
            <div class="chart-header">
              <div>
                <div class="chart-title">Comparison</div>
                <div class="chart-subtitle">Top values by category</div>
              </div>
              <div class="chart-actions">
                <button class="btn-chart active" onclick="setChartType('comp','bar',this)">V-Bar</button>
                <button class="btn-chart" onclick="setChartType('comp','hbar',this)">H-Bar</button>
              </div>
            </div>
            <div class="chart-wrap"><canvas id="chart-comp"></canvas></div>
          </div>

          <div class="chart-card anim anim-4">
            <div class="chart-header">
              <div>
                <div class="chart-title">Scatter / Correlation</div>
                <div class="chart-subtitle" id="scatter-subtitle">Col 1 vs Col 2</div>
              </div>
            </div>
            <div class="chart-wrap"><canvas id="chart-scatter"></canvas></div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="table-card" id="data-table-section">
          <div class="table-header">
            <div class="table-title">ğŸ“‹ Raw Data</div>
            <input type="text" class="search-input" id="search-box"
                   placeholder="ğŸ” Searchâ€¦" oninput="filterTable(this.value)" aria-label="Search data" />
          </div>
          <div class="col-selector" id="col-selector"></div>
          <div class="table-wrap" tabindex="0">
            <table>
              <thead id="table-head"></thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
          <div class="pagination">
            <span id="pagination-info">No data loaded</span>
            <div class="page-btns" id="page-btns"></div>
          </div>
        </div>

      </section>
    </main>
  </div>
</div>

<div class="toast" id="toast" role="alert" aria-live="assertive"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â”€â”€ State â”€â”€ */
let rawData      = [];
let filteredData = [];
let visibleCols  = [];
let charts       = {};
let currentPage  = 1;
const PAGE_SIZE  = 25;
let searchQuery  = '';
let sortCol      = null;
let sortDir      = 1;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSidebar() {
  const sb  = document.getElementById('sidebar');
  const ov  = document.getElementById('overlay');
  const hbg = document.getElementById('hamburger');
  const open = sb.classList.toggle('open');
  ov.classList.toggle('open', open);
  hbg.setAttribute('aria-expanded', String(open));
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('hamburger').setAttribute('aria-expanded', 'false');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSection(name) {
  document.getElementById('section-upload').style.display    = (name === 'upload')    ? 'block' : 'none';
  document.getElementById('section-dashboard').style.display = (name === 'dashboard') ? 'block' : 'none';
  document.getElementById('topbar-title').textContent = name === 'upload' ? 'Import Data' : 'Dashboard';
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const items = document.querySelectorAll('.nav-item');
  if (name === 'upload')    items[0].classList.add('active');
  if (name === 'dashboard') items[1].classList.add('active');
  closeSidebar();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function goToTable() {
  if (!rawData.length) return;
  showSection('dashboard');
  setTimeout(() => document.getElementById('data-table-section').scrollIntoView({ behavior: 'smooth' }), 120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function triggerUpload() { document.getElementById('file-input').click(); }

function handleDragOver(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.add('drag-over');
}
function handleDragLeave() {
  document.getElementById('drop-zone').classList.remove('drag-over');
}
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
}
function handleFileInput(e) {
  const file = e.target.files[0];
  if (file) processFile(file);
  e.target.value = '';
}

function processFile(file) {
  const ext     = file.name.split('.').pop().toLowerCase();
  const allowed = ['csv','json','tsv','txt'];
  if (!allowed.includes(ext)) {
    return toast(`Unsupported type ".${ext}". Use CSV, JSON, or TSV.`, 'error');
  }
  showProgress(true);
  setProgress(10, 'Reading fileâ€¦');

  const reader = new FileReader();
  reader.onload = (ev) => {
    setProgress(50, 'Parsing dataâ€¦');
    try {
      let data;
      if (ext === 'json') {
        const parsed = JSON.parse(ev.target.result);
        data = Array.isArray(parsed) ? parsed : (parsed.data || Object.values(parsed)[0]);
        if (!Array.isArray(data)) throw new Error('JSON must be a top-level array of objects.');
      } else {
        const delim  = ext === 'tsv' ? '\t' : ',';
        const result = Papa.parse(ev.target.result.trim(), {
          header: true, delimiter: delim,
          skipEmptyLines: true, dynamicTyping: true,
        });
        if (result.errors.length && !result.data.length) throw new Error(result.errors[0].message);
        data = result.data;
      }
      if (!data || data.length === 0) throw new Error('No rows found. Check your file format.');
      setProgress(80, 'Building visualizationsâ€¦');
      setTimeout(() => {
        loadData(data, file.name);
        setProgress(100, 'Done!');
        setTimeout(() => showProgress(false), 700);
        document.getElementById('file-info').textContent = `${file.name} Â· ${data.length.toLocaleString()} rows`;
      }, 250);
    } catch (err) {
      showProgress(false);
      toast(`Parse error: ${err.message}`, 'error');
    }
  };
  reader.onerror = () => { showProgress(false); toast('Failed to read file.', 'error'); };
  reader.readAsText(file);
}

function showProgress(show) {
  document.getElementById('upload-progress').style.display = show ? 'block' : 'none';
}
function setProgress(pct, text) {
  document.getElementById('progress-bar').style.width  = pct + '%';
  document.getElementById('progress-text').textContent = text;
  document.getElementById('progress-pct').textContent  = pct + '%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAMPLE DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadSample(type) {
  const months   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const regions  = ['North','South','East','West','Central'];
  const products = ['Widget A','Widget B','Widget C','Gadget X','Gadget Y'];
  const depts    = ['Engineering','Marketing','Sales','HR','Finance','Design'];
  const statuses = ['Delivered','Pending','Shipped','Cancelled'];
  let data;

  if (type === 'sales') {
    data = months.flatMap(m =>
      products.slice(0,3).map(p => ({
        Month:   m,
        Product: p,
        Revenue: Math.round(Math.random() * 50000 + 5000),
        Units:   Math.round(Math.random() * 200 + 20),
        Region:  regions[Math.floor(Math.random() * regions.length)],
        Margin:  +(Math.random() * 0.4 + 0.1).toFixed(2),
      }))
    );
  } else if (type === 'employees') {
    data = Array.from({ length: 80 }, (_, i) => ({
      EmployeeID: `E${1000 + i}`,
      Name:       `Employee ${i + 1}`,
      Department: depts[Math.floor(Math.random() * depts.length)],
      Salary:     Math.round(Math.random() * 100000 + 40000),
      YearsExp:   Math.round(Math.random() * 20 + 1),
      Rating:     +(Math.random() * 2 + 3).toFixed(1),
      Remote:     Math.random() > .5 ? 'Yes' : 'No',
    }));
  } else {
    data = Array.from({ length: 120 }, (_, i) => ({
      OrderID:  `ORD-${10000 + i}`,
      Product:  products[Math.floor(Math.random() * products.length)],
      Category: ['Electronics','Apparel','Books','Food'][Math.floor(Math.random() * 4)],
      Amount:   Math.round(Math.random() * 500 + 10),
      Quantity: Math.round(Math.random() * 10 + 1),
      Status:   statuses[Math.floor(Math.random() * statuses.length)],
      Region:   regions[Math.floor(Math.random() * regions.length)],
    }));
  }
  loadData(data, `${type}_sample.csv`);
  document.getElementById('file-info').textContent = `${type}_sample Â· ${data.length} rows`;
  toast(`Loaded "${type}" sample dataset`, 'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadData(data) {
  rawData      = data;
  filteredData = [...rawData];
  visibleCols  = Object.keys(rawData[0]);
  buildKPIs();
  buildCharts();
  buildTable();
  document.getElementById('nav-dashboard').disabled = false;
  document.getElementById('btn-reset').style.display = 'inline-flex';
  showSection('dashboard');
}

function resetDashboard() {
  rawData = []; filteredData = []; visibleCols = [];
  Object.values(charts).forEach(c => { try { c.destroy(); } catch (e) {} });
  charts = {};
  ['kpi-row','table-head','table-body','col-selector','page-btns'].forEach(id => {
    document.getElementById(id).innerHTML = '';
  });
  document.getElementById('nav-dashboard').disabled  = true;
  document.getElementById('btn-reset').style.display = 'none';
  document.getElementById('pagination-info').textContent = 'No data loaded';
  document.getElementById('file-info').textContent = '';
  showSection('upload');
  toast('Dashboard reset', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPIs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildKPIs() {
  const cols    = Object.keys(rawData[0]);
  const numCols = cols.filter(c => rawData.some(r => typeof r[c] === 'number'));
  const catCols = cols.filter(c => rawData.some(r => typeof r[c] === 'string'));
  const row     = document.getElementById('kpi-row');
  row.innerHTML = '';

  const kpis = [
    { label: 'Total Rows', value: rawData.length.toLocaleString(), sub: 'records loaded' },
    { label: 'Columns',    value: cols.length,                     sub: 'fields detected' },
  ];

  numCols.slice(0, 2).forEach(col => {
    const vals = rawData.map(r => r[col]).filter(v => typeof v === 'number');
    const sum  = vals.reduce((a, b) => a + b, 0);
    const avg  = sum / vals.length;
    kpis.push({ label: `Total ${col}`, value: fmtNum(sum), sub: `avg ${fmtNum(avg)}` });
  });

  if (catCols.length) {
    const uniq = new Set(rawData.map(r => r[catCols[0]]));
    kpis.push({ label: `Unique ${catCols[0]}`, value: uniq.size, sub: 'distinct values' });
  }

  kpis.slice(0, 5).forEach(k => {
    const card = document.createElement('div');
    card.className = 'kpi-card';
    card.innerHTML = `<div class="kpi-label">${k.label}</div><div class="kpi-value">${k.value}</div><div class="kpi-sub">${k.sub}</div>`;
    row.appendChild(card);
  });
}

function fmtNum(n) {
  if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n % 1 === 0 ? n.toLocaleString() : n.toFixed(2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLORS = [
  'rgba(0,229,255,.85)', 'rgba(255,79,216,.85)', 'rgba(163,255,112,.85)',
  'rgba(255,201,77,.85)','rgba(100,130,255,.85)', 'rgba(255,120,80,.85)',
  'rgba(0,200,150,.85)', 'rgba(220,80,180,.85)',
];

function getNumCols() { return Object.keys(rawData[0]).filter(c => rawData.some(r => typeof r[c] === 'number')); }
function getCatCols() { return Object.keys(rawData[0]).filter(c => rawData.some(r => typeof r[c] === 'string')); }

function buildCharts() {
  Object.values(charts).forEach(c => { try { c.destroy(); } catch (e) {} });
  charts = {};

  const numCols   = getNumCols();
  const catCols   = getCatCols();
  const sampleRows = rawData.slice(0, 50);
  const labels    = sampleRows.map((row, i) =>
    catCols.length ? String(row[catCols[0]] ?? `Row ${i + 1}`) : `Row ${i + 1}`
  );

  /* Trend */
  if (numCols.length) {
    const col = numCols[0];
    document.getElementById('trend-subtitle').textContent = `${col} over rows`;
    charts.trend = new Chart(document.getElementById('chart-trend'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: col,
          data: sampleRows.map(r => r[col]),
          borderColor: COLORS[0], backgroundColor: 'rgba(0,229,255,.07)',
          fill: true, tension: 0.4, pointRadius: 3, pointHoverRadius: 6,
        }],
      },
      options: baseOpts(),
    });
  }

  /* Distribution */
  if (catCols.length) {
    const col    = catCols[0];
    const counts = {};
    rawData.forEach(r => { const v = r[col]; counts[v] = (counts[v] || 0) + 1; });
    const top = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8);
    document.getElementById('dist-subtitle').textContent = `${col} breakdown`;
    charts.dist = new Chart(document.getElementById('chart-dist'), {
      type: 'doughnut',
      data: {
        labels: top.map(e => e[0]),
        datasets: [{ data: top.map(e => e[1]), backgroundColor: COLORS, borderColor: '#161b24', borderWidth: 2 }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#6b7a99', font: { family: 'DM Mono', size: 11 }, boxWidth: 12 } },
          tooltip: tooltipOpts(),
        },
      },
    });
  }

  /* Comparison */
  if (catCols.length && numCols.length) {
    const catCol = catCols[0], numCol = numCols[0];
    const agg = {};
    rawData.forEach(r => { const k = r[catCol]; agg[k] = (agg[k] || 0) + (r[numCol] || 0); });
    const top = Object.entries(agg).sort((a, b) => b[1] - a[1]).slice(0, 10);
    charts.comp = new Chart(document.getElementById('chart-comp'), {
      type: 'bar',
      data: {
        labels: top.map(e => e[0]),
        datasets: [{ label: numCol, data: top.map(e => e[1]), backgroundColor: COLORS[0], borderRadius: 5 }],
      },
      options: baseOpts(),
    });
  }

  /* Scatter / fallback */
  if (numCols.length >= 2) {
    const xCol = numCols[0], yCol = numCols[1];
    document.getElementById('scatter-subtitle').textContent = `${xCol} vs ${yCol}`;
    charts.scatter = new Chart(document.getElementById('chart-scatter'), {
      type: 'scatter',
      data: {
        datasets: [{
          label: `${xCol} vs ${yCol}`,
          data: rawData.slice(0, 300).map(r => ({ x: r[xCol], y: r[yCol] })),
          backgroundColor: COLORS[1], pointRadius: 4,
        }],
      },
      options: baseOpts(),
    });
  } else if (catCols.length >= 2) {
    const col    = catCols[1];
    const counts = {};
    rawData.forEach(r => { const v = r[col]; counts[v] = (counts[v] || 0) + 1; });
    const top = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    charts.scatter = new Chart(document.getElementById('chart-scatter'), {
      type: 'bar',
      data: {
        labels: top.map(e => e[0]),
        datasets: [{ label: col, data: top.map(e => e[1]), backgroundColor: COLORS[4], borderRadius: 5 }],
      },
      options: baseOpts(),
    });
  }
}

function tooltipOpts() {
  return {
    backgroundColor: '#161b24', titleColor: '#e8edf5',
    bodyColor: '#6b7a99', borderColor: '#1f2535', borderWidth: 1, padding: 10,
  };
}

function baseOpts() {
  return {
    responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { labels: { color: '#6b7a99', font: { family: 'DM Mono', size: 11 } } },
      tooltip: tooltipOpts(),
    },
    scales: {
      x: { grid: { color: '#1f253540' }, ticks: { color: '#6b7a99', font: { family: 'DM Mono', size: 10 }, maxRotation: 45 } },
      y: { grid: { color: '#1f253540' }, ticks: { color: '#6b7a99', font: { family: 'DM Mono', size: 10 } } },
    },
  };
}

function setChartType(key, type, btn) {
  btn.closest('.chart-actions').querySelectorAll('.btn-chart').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const chart = charts[key];
  if (!chart) return;
  if (type === 'area') {
    chart.config.type = 'line';
    if (chart.data.datasets[0]) chart.data.datasets[0].fill = true;
  } else if (type === 'hbar') {
    chart.config.type = 'bar';
    chart.options.indexAxis = 'y';
  } else {
    chart.config.type = type;
    delete chart.options.indexAxis;
    if (chart.data.datasets[0] && type === 'line') chart.data.datasets[0].fill = false;
  }
  chart.update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTable() {
  if (!rawData.length) return;
  visibleCols = Object.keys(rawData[0]);
  renderColSelector();
  renderTable();
}

function renderColSelector() {
  const sel = document.getElementById('col-selector');
  sel.innerHTML = '<span style="font-family:var(--fm);font-size:.7rem;color:var(--muted);flex-shrink:0">Columns:</span>';
  Object.keys(rawData[0]).forEach(col => {
    const badge = document.createElement('div');
    badge.className = 'col-badge active';
    badge.setAttribute('role', 'checkbox');
    badge.setAttribute('aria-checked', 'true');
    badge.setAttribute('tabindex', '0');
    badge.innerHTML = `<span>âœ“</span>${col}`;
    badge.dataset.col = col;
    const toggle = () => {
      if (visibleCols.includes(col)) {
        if (visibleCols.length === 1) return;
        visibleCols = visibleCols.filter(c => c !== col);
        badge.classList.remove('active');
        badge.querySelector('span').textContent = '+';
        badge.setAttribute('aria-checked', 'false');
      } else {
        visibleCols.push(col);
        badge.classList.add('active');
        badge.querySelector('span').textContent = 'âœ“';
        badge.setAttribute('aria-checked', 'true');
      }
      renderTable();
    };
    badge.onclick   = toggle;
    badge.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } };
    sel.appendChild(badge);
  });
}

function filterTable(q) {
  searchQuery  = q.toLowerCase();
  currentPage  = 1;
  filteredData = rawData.filter(row =>
    Object.values(row).some(v => String(v ?? '').toLowerCase().includes(searchQuery))
  );
  renderTable();
}

function sortTable(col) {
  sortDir = (sortCol === col) ? sortDir * -1 : 1;
  sortCol = col;
  filteredData.sort((a, b) => {
    const av = a[col], bv = b[col];
    if (av == null) return 1; if (bv == null) return -1;
    return av < bv ? -sortDir : av > bv ? sortDir : 0;
  });
  renderTable();
}

function renderTable() {
  const head  = document.getElementById('table-head');
  const tbody = document.getElementById('table-body');

  head.innerHTML = '<tr>' + visibleCols.map(c => {
    const arrow  = sortCol === c ? (sortDir === 1 ? ' â†‘' : ' â†“') : '';
    const safeC  = c.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    return `<th onclick="sortTable('${safeC}')">${c}${arrow}</th>`;
  }).join('') + '</tr>';

  const start = (currentPage - 1) * PAGE_SIZE;
  const page  = filteredData.slice(start, start + PAGE_SIZE);
  tbody.innerHTML = page.map(row =>
    '<tr>' + visibleCols.map(c => {
      const v = row[c] ?? '';
      return `<td>${String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>`;
    }).join('') + '</tr>'
  ).join('');

  const total = filteredData.length;
  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  document.getElementById('pagination-info').textContent =
    `Showing ${total ? start + 1 : 0}â€“${Math.min(start + PAGE_SIZE, total)} of ${total.toLocaleString()} rows`;

  const btnsEl = document.getElementById('page-btns');
  btnsEl.innerHTML = '';
  const mkBtn = (label, pg, active) => {
    const b = document.createElement('button');
    b.className  = 'page-btn' + (active ? ' active' : '');
    b.textContent = label;
    b.onclick     = () => { currentPage = pg; renderTable(); };
    return b;
  };
  if (currentPage > 1)    btnsEl.appendChild(mkBtn('â€¹', currentPage - 1, false));
  const s = Math.max(1, currentPage - 2);
  const e = Math.min(pages, currentPage + 2);
  for (let p = s; p <= e; p++) btnsEl.appendChild(mkBtn(p, p, p === currentPage));
  if (currentPage < pages) btnsEl.appendChild(mkBtn('â€º', currentPage + 1, false));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV() {
  if (!rawData.length) return toast('No data to export.', 'error');
  const cols = visibleCols;
  const csv  = [
    cols.join(','),
    ...filteredData.map(row =>
      cols.map(c => {
        const v = row[c] ?? '';
        return (typeof v === 'string' && /[,"\n]/.test(v)) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',')
    ),
  ].join('\n');
  download('datapulse_export.csv', csv, 'text/csv');
  toast('CSV exported!', 'success');
}

function exportJSON() {
  if (!rawData.length) return toast('No data to export.', 'error');
  const out = filteredData.map(row => {
    const obj = {};
    visibleCols.forEach(c => { obj[c] = row[c]; });
    return obj;
  });
  download('datapulse_export.json', JSON.stringify(out, null, 2), 'application/json');
  toast('JSON exported!', 'success');
}

function exportChartPNG() {
  const canvas = document.getElementById('chart-trend');
  if (!canvas) return toast('No chart available.', 'error');
  const a = document.createElement('a');
  a.download = 'datapulse_chart.png';
  a.href     = canvas.toDataURL('image/png');
  a.click();
  toast('Chart PNG exported!', 'success');
}

function exportAll() {
  if (!rawData.length) { showSection('upload'); return; }
  exportCSV();
}

function printDashboard() { window.print(); }

function download(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer = null;
function toast(msg, type = 'info') {
  const el   = document.getElementById('toast');
  const icon = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' }[type] || '';
  el.textContent = '';
  el.appendChild(document.createTextNode(`${icon} ${msg}`));
  el.className   = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESIZE â€” redraw charts
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let resizeTimer = null;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    Object.values(charts).forEach(c => { try { c.resize(); } catch (e) {} });
  }, 200);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SWITCHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const THEMES = {
  dark:   { icon: 'ğŸŒ™', label: 'Midnight' },
  light:  { icon: 'â˜€ï¸', label: 'Arctic Light' },
  forest: { icon: 'ğŸŒ¿', label: 'Forest' },
  ember:  { icon: 'ğŸ”¥', label: 'Ember' },
  violet: { icon: 'ğŸ”®', label: 'Violet Dusk' },
};
let currentTheme = 'dark';

function toggleThemePanel() {
  const panel = document.getElementById('theme-panel');
  const btn   = document.getElementById('btn-theme');
  const open  = panel.classList.toggle('open');
  btn.setAttribute('aria-expanded', String(open));
}

function applyTheme(theme, optEl) {
  currentTheme = theme;
  /* Remove all theme data attrs */
  const html = document.documentElement;
  html.removeAttribute('data-theme');
  if (theme !== 'dark') html.setAttribute('data-theme', theme);

  /* Update meta theme-color for mobile */
  const metaColor = { dark:'#0a0c10', light:'#f0f4fa', forest:'#080e0a', ember:'#0e0905', violet:'#09080f' };
  document.querySelector('meta[name="theme-color"]').content = metaColor[theme] || '#0a0c10';

  /* Update topbar icon */
  document.getElementById('theme-icon').textContent = THEMES[theme]?.icon || 'ğŸ¨';

  /* Update active state */
  document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
  if (optEl) optEl.classList.add('active');

  /* Close panel */
  document.getElementById('theme-panel').classList.remove('open');
  document.getElementById('btn-theme').setAttribute('aria-expanded', 'false');

  /* Persist */
  try { localStorage.setItem('dp-theme', theme); } catch (e) {}

  /* Redraw chart colors for new theme */
  const isDark = theme !== 'light';
  const tickColor  = isDark ? '#6b7a99' : '#556080';
  const gridColor  = isDark ? '#1f253540' : '#dde3ef80';
  const legendColor = tickColor;
  Object.values(charts).forEach(c => {
    try {
      if (c.options.scales) {
        ['x','y'].forEach(ax => {
          if (c.options.scales[ax]) {
            c.options.scales[ax].grid.color  = gridColor;
            c.options.scales[ax].ticks.color = tickColor;
          }
        });
      }
      if (c.options.plugins?.legend?.labels) {
        c.options.plugins.legend.labels.color = legendColor;
      }
      c.update('none');
    } catch (e) {}
  });

  toast(`Theme: ${THEMES[theme]?.label}`, 'info');
}

/* Restore saved theme on load */
(function () {
  try {
    const saved = localStorage.getItem('dp-theme');
    if (saved && THEMES[saved]) {
      const opt = document.querySelector(`.theme-option[data-theme="${saved}"]`);
      applyTheme(saved, opt);
    }
  } catch (e) {}
})();

/* Close theme panel when clicking outside */
document.addEventListener('click', function (e) {
  const panel = document.getElementById('theme-panel');
  const btn   = document.getElementById('btn-theme');
  if (panel.classList.contains('open') && !panel.contains(e.target) && !btn.contains(e.target)) {
    panel.classList.remove('open');
    btn.setAttribute('aria-expanded', 'false');
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEVTOOLS / INSPECT PROTECTION
   Blocks F12, Ctrl+Shift+I/J/U/C,
   right-click context menu, text selection,
   and detects open devtools via timing.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function _protect() {

  /* 1. Block right-click */
  document.addEventListener('contextmenu', function (e) { e.preventDefault(); });

  /* 2. Block keyboard shortcuts */
  document.addEventListener('keydown', function (e) {
    const k = e.key;
    /* F12 */
    if (k === 'F12') { e.preventDefault(); return false; }
    /* Ctrl/Cmd + Shift + I / J / C */
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (k === 'I' || k === 'i' || k === 'J' || k === 'j' || k === 'C' || k === 'c')) {
      e.preventDefault(); return false;
    }
    /* Ctrl/Cmd + U (view source) */
    if ((e.ctrlKey || e.metaKey) && (k === 'U' || k === 'u')) {
      e.preventDefault(); return false;
    }
    /* Ctrl/Cmd + S (save page) */
    if ((e.ctrlKey || e.metaKey) && (k === 'S' || k === 's')) {
      e.preventDefault(); return false;
    }
    /* Ctrl/Cmd + A (select all) */
    if ((e.ctrlKey || e.metaKey) && (k === 'A' || k === 'a')) {
      e.preventDefault(); return false;
    }
  });

  /* 3. Disable text selection */
  document.addEventListener('selectstart', function (e) { e.preventDefault(); });

  /* 4. Disable drag */
  document.addEventListener('dragstart', function (e) { e.preventDefault(); });

  /* 5. DevTools size-detection â€” redirects if panel is open */
  const _threshold = 160;
  function _checkDevTools() {
    const widthGap  = window.outerWidth  - window.innerWidth;
    const heightGap = window.outerHeight - window.innerHeight;
    if (widthGap > _threshold || heightGap > _threshold) {
      document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100dvh;background:#0a0c10;font-family:monospace;color:#ff5c5c;font-size:1.1rem;text-align:center;padding:24px;">ğŸš« Developer tools detected.<br>Please close DevTools to use this application.</div>';
    }
  }
  setInterval(_checkDevTools, 1000);
  window.addEventListener('resize', _checkDevTools);

  /* 6. Console warning */
  const _w = '%cSTOP!';
  const _s = 'color:red;font-size:2rem;font-weight:bold;';
  const _m = '%cThis application is protected. Do not paste or run code here.';
  const _s2 = 'color:#ff5c5c;font-size:1rem;';
  console.log(_w, _s); console.log(_m, _s2);

  
})();
</script>
</body>
</html>
